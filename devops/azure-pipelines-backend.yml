# Backend CI/CD Pipeline
trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - FinancialManagement/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '8.0.x'
  backendSolution: 'FinancialManagement/FinancialManagement.sln'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildAndTest
    displayName: 'Build and Test Backend'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '$(dotNetVersion)'
      displayName: 'Install .NET SDK'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'restore'
        projects: '$(backendSolution)'
      displayName: 'Restore NuGet packages'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        projects: '$(backendSolution)'
        arguments: '--configuration $(buildConfiguration)'
      displayName: 'Build solution'

    # TODO: Adicionar testes quando implementados
    # - task: DotNetCoreCLI@2
    #   inputs:
    #     command: 'test'
    #     projects: '**/*Tests/*.csproj'
    #     arguments: '--configuration $(buildConfiguration) --collect "Code coverage"'
    #   displayName: 'Run tests'

    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
      displayName: 'Publish projects'

    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'backend'
      displayName: 'Publish artifacts'

# TODO: Adicionar est√°gio de deployment
# - stage: Deploy
#   displayName: 'Deploy to Environment'
#   dependsOn: Build
#   condition: succeeded()
#   jobs:
#   - deployment: DeployBackend
#     displayName: 'Deploy to Azure App Service'
#     environment: 'Development'
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           # Adicionar passos de deployment
